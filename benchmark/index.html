<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tidy Butt: Y Cam Cyntaf | Distance Travelled</title>

  <link rel="stylesheet" href="/y-cam-cyntaf/assets/css/styles.css" />
  <script defer src="/y-cam-cyntaf/assets/js/layout.js"></script>
</head>

<body>
  <div data-page-content data-sidebar="true">

    <h1>Distance Travelled</h1>
    <p class="small">
      A private confidence check-in used at the start and end of the course.
      This is not graded and you cannot fail.
    </p>

    <main id="dtRoot"></main>

  </div>

<script>
(function () {
  "use strict";

  const APPS_SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbzu-Suutn_00ELOAjaU6RiQNEO0QPQinn89mCDu5hf6azw82TSiK9rPS3hc4hUOd9jGLg/exec";

  const STORAGE_KEYS = {
    start: "tidybutt_ycc_distanceTravelled_v1_start",
    end: "tidybutt_ycc_distanceTravelled_v1_end",
    anonId: "tidybutt_ycc_distanceTravelled_v1_anonId",
    lastSentAt: "tidybutt_ycc_distanceTravelled_v1_lastSentAt"
  };

  const ITEMS = [
    { id: "listen_general", title: "Listening: I feel ok listening to Welsh, even if I only catch a few words." },
    { id: "listen_audio", title: "Listening with audio: I feel confident using audio to learn Welsh." },
    { id: "speak_word", title: "Speaking: I feel ok saying a word or short phrase out loud." },
    { id: "speak_learners", title: "Speaking with other learners: I feel ok practising with another learner." },
    { id: "speak_confident", title: "Speaking with confident Welsh speakers: I feel ok trying Welsh." },
    { id: "reading", title: "Reading: I can recognise familiar Welsh words when I see them." },
    { id: "writing", title: "Writing: I feel ok writing a short Welsh message." },
    { id: "public", title: "Public spaces: I feel ok using Welsh in shops, cafés, or community spaces." }
  ];

  const SCALE = [
    { v: 0, a: "Not yet" },
    { v: 1, a: "Just starting" },
    { v: 2, a: "A bit" },
    { v: 3, a: "Mostly" },
    { v: 4, a: "Yes, comfortably" }
  ];

  const MAX_TOTAL = ITEMS.length * 4;

  function initBenchmark() {
    const root = document.getElementById("dtRoot");

    root.innerHTML = `
      <section class="dt-card">
        <div class="dt-actions">
          <button class="dt-btn" id="dtSave">Save on this device</button>
          <button class="dt-btn" id="dtSend">Send to Tidy Butt</button>
          <button class="dt-btn" id="dtExport">Download Word document</button>
        </div>
        <p class="dt-status" id="dtStatus"></p>
        <p class="dt-footer-note" id="dtLastSent"></p>
      </section>
    `;

    const saveBtn = document.getElementById("dtSave");
    const sendBtn = document.getElementById("dtSend");
    const exportBtn = document.getElementById("dtExport");
    const statusEl = document.getElementById("dtStatus");
    const lastSentEl = document.getElementById("dtLastSent");

    function getAnonId() {
      let id = localStorage.getItem(STORAGE_KEYS.anonId);
      if (!id) {
        id = "anon_" + Math.random().toString(16).slice(2);
        localStorage.setItem(STORAGE_KEYS.anonId, id);
      }
      return id;
    }

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    function setLastSent() {
      const iso = localStorage.getItem(STORAGE_KEYS.lastSentAt);
      if (!iso) return;
      lastSentEl.textContent =
        "Last sent (queued): " + new Date(iso).toLocaleString("en-GB");
    }

    saveBtn.onclick = () => {
      localStorage.setItem(
        STORAGE_KEYS.start,
        JSON.stringify({ savedAt: new Date().toISOString() })
      );
      setStatus("Saved on this device.");
    };

    sendBtn.onclick = () => {
      const payload = {
        version: "v1",
        sentAt: new Date().toISOString(),
        anonId: getAnonId(),
        checkpoint: "end",
        scores: {},
        notes: {}
      };

      setStatus("Sending (queued)…");

      fetch(APPS_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(() => {
        const iso = new Date().toISOString();
        localStorage.setItem(STORAGE_KEYS.lastSentAt, iso);
        sendBtn.disabled = true;
        sendBtn.textContent = "Sent (queued)";
        setStatus("Sent (queued). Thank you.");
        setLastSent();
      });
    };

    exportBtn.onclick = () => {
      const html =
        "<html><body><h2>Distance Travelled</h2><p>Private reflection.</p></body></html>";
      const blob = new Blob(["\ufeff", html], { type: "application/msword" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "Distance-Travelled.doc";
      a.click();
      URL.revokeObjectURL(a.href);
    };

    setLastSent();
  }

  window.addEventListener("layout:ready", initBenchmark);
})();
</script>

</body>
</html>
