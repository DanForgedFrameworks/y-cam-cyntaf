<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tidy Butt: Y Cam Cyntaf | Distance Travelled (Confidence Check-in)</title>

  <style>
    :root{
      --bg: #0f172a;
      --card: #0b1220;
      --panel: #0f1b33;
      --text: #e5e7eb;
      --muted: #cbd5e1;
      --quiet: #94a3b8;
      --line: rgba(255,255,255,0.12);
      --focus: rgba(107,32,210,0.55);

      /* Theme accents aligned with your site update */
      --tidy-orange: #ff981d;
      --tidy-purple: #6b20d2;
      --tidy-blue: #43a7e3;

      --good: #34d399;
      --warn: #fbbf24;
      --soft: rgba(67,167,227,0.16);
      --danger: #fb7185;

      --radius: 16px;
      --shadow: 0 18px 40px rgba(0,0,0,0.45);
      --glow: 0 0 36px rgba(67,167,227,0.22);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }

    body{
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 520px at 12% 10%, rgba(107,32,210,0.22), transparent 60%),
        radial-gradient(900px 520px at 88% 20%, rgba(67,167,227,0.18), transparent 55%),
        linear-gradient(180deg, #070b14, var(--bg));
      min-height: 100vh;
      padding: clamp(14px, 3vw, 28px);
    }

    a{ color: rgba(255,255,255,0.92); }
    a:hover{ color: #ffffff; }

    a:focus-visible, button:focus-visible, textarea:focus-visible{
      outline: 3px solid var(--focus);
      outline-offset: 3px;
      border-radius: 12px;
    }

    .dt-container{
      width: min(1020px, 100%);
      margin: 0 auto;
    }

    .dt-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow), var(--glow);
      overflow: hidden;
    }

    .dt-header{
      padding: clamp(16px, 3.2vw, 26px);
      background: linear-gradient(90deg, rgba(107,32,210,0.22), rgba(67,167,227,0.18));
      border-bottom: 1px solid var(--line);
    }

    .dt-title{
      margin: 0 0 8px 0;
      font-size: clamp(20px, 2.6vw, 30px);
      letter-spacing: 0.2px;
      line-height: 1.2;
    }

    .dt-intro{
      margin: 0;
      color: var(--muted);
      line-height: 1.55;
      max-width: 70ch;
    }

    .dt-reassure{
      margin-top: 12px;
      padding: 12px 14px;
      background: rgba(52,211,153,0.10);
      border: 1px solid rgba(52,211,153,0.22);
      border-radius: 12px;
      color: var(--text);
    }

    .dt-reassure strong{ color: #bbf7d0; }

    .dt-body{
      padding: clamp(14px, 3vw, 24px);
      display: grid;
      gap: 14px;
    }

    .dt-row{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: start;
    }

    .dt-panel{
      background: rgba(15,27,51,0.55);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 0 24px rgba(67,167,227,0.12);
    }

    .dt-panel h2{
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .dt-small{
      margin: 0;
      color: var(--quiet);
      font-size: 13px;
      line-height: 1.5;
    }

    .dt-controls{
      display: grid;
      gap: 12px;
    }

    .dt-mode{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .dt-seg{
      display: inline-flex;
      border: 1px solid var(--line);
      border-radius: 999px;
      overflow: hidden;
      background: rgba(255,255,255,0.03);
    }

    .dt-seg button{
      appearance: none;
      border: 0;
      background: transparent;
      color: var(--text);
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 650;
      letter-spacing: 0.2px;
      min-width: 120px;
    }

    .dt-seg button[aria-pressed="true"]{
      background: rgba(107,32,210,0.26);
      border-right: 1px solid rgba(255,255,255,0.08);
      border-left: 1px solid rgba(255,255,255,0.08);
    }

    .dt-hint{
      margin-top: 8px;
      color: var(--quiet);
      font-size: 13px;
      line-height: 1.45;
    }

    .dt-items{
      display: grid;
      gap: 14px;
    }

    fieldset.dt-item{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      margin: 0;
      background: rgba(255,255,255,0.02);
      box-shadow: 0 0 24px rgba(67,167,227,0.10);
    }

    fieldset.dt-item:focus-within{
      outline: 3px solid rgba(107,32,210,0.40);
      outline-offset: 2px;
    }

    fieldset.dt-item:nth-of-type(odd){
      background: rgba(255,255,255,0.025);
      border-color: rgba(67,167,227,0.22);
    }

    fieldset.dt-item:nth-of-type(even){
      background: rgba(107,32,210,0.08);
      border-color: rgba(107,32,210,0.22);
    }

    .dt-tag{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      color: var(--muted);
      margin-top: 8px;
      width: fit-content;
    }

    .dt-legend{
      padding: 0 6px;
      font-weight: 800;
      line-height: 1.35;
    }

    .dt-why{
      margin: 6px 0 10px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .dt-scale{
      display: grid;
      gap: 10px;
    }

    .dt-scale-row{
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
    }

    .dt-choice{
      position: relative;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 10px 12px;
      background: rgba(15,27,51,0.35);
      min-height: 64px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      justify-content: space-between;
    }

    .dt-choice input{
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .dt-choice .dt-num{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--quiet);
    }

    .dt-choice .dt-anchor{
      font-weight: 750;
      font-size: 13px;
      line-height: 1.25;
      color: var(--text);
    }

    .dt-choice:has(input:focus-visible){
      outline: 3px solid rgba(107,32,210,0.55);
      outline-offset: 2px;
    }

    .dt-choice:has(input:checked){
      border-color: rgba(67,167,227,0.60);
      background: rgba(67,167,227,0.14);
    }

    .dt-notes{
      margin-top: 10px;
      display: grid;
      gap: 6px;
    }

    .dt-notes label{
      font-size: 13px;
      font-weight: 650;
      color: var(--muted);
    }

    textarea.dt-textarea{
      width: 100%;
      resize: vertical;
      min-height: 76px;
      max-height: 220px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      font-family: var(--sans);
      line-height: 1.45;
    }

    .dt-progress{
      display: grid;
      gap: 12px;
    }

    .dt-scoreline{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: baseline;
      justify-content: space-between;
    }

    .dt-scoreline .dt-score{
      font-size: 14px;
      color: var(--muted);
    }

    .dt-scoreline .dt-score strong{
      color: var(--text);
      font-size: 16px;
    }

    .dt-bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      overflow: hidden;
    }

    .dt-bar > span{
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(107,32,210,0.72), rgba(67,167,227,0.70));
      border-radius: 999px;
      transition: width 240ms ease;
    }

    .dt-message{
      margin: 0;
      color: var(--muted);
      line-height: 1.55;
      font-size: 13px;
    }

    .dt-actions{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
    }

    .dt-btn{
      appearance: none;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 13px;
    }

    .dt-btn.primary{
      background: rgba(255,152,29,0.18);
      border-color: rgba(255,152,29,0.42);
    }

    .dt-btn.primary:hover{
      background: rgba(255,152,29,0.22);
      border-color: rgba(255,152,29,0.52);
    }

    .dt-btn.danger{
      background: rgba(251,113,133,0.14);
      border-color: rgba(251,113,133,0.28);
    }

    .dt-status{
      min-height: 1.2em;
      color: var(--quiet);
      font-size: 13px;
      line-height: 1.4;
    }

    .dt-status strong{ color: var(--text); }

    .dt-footer-note{
      color: var(--quiet);
      font-size: 12px;
      line-height: 1.45;
      margin: 0;
    }

    .dt-bottom-actions{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
      margin-top: 4px;
    }

    .dt-bottom-actions .dt-btn{
      min-width: 160px;
    }

    .dt-summary{
      margin-top: 4px;
    }

    .dt-summary-grid{
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .dt-summary-box{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.02);
      box-shadow: 0 0 22px rgba(67,167,227,0.10);
    }

    .dt-summary-label{
      font-size: 12px;
      color: var(--quiet);
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }

    .dt-summary-value{
      margin-top: 6px;
      font-weight: 900;
      font-size: 16px;
      line-height: 1.2;
      color: var(--text);
    }

    .dt-summary-sub{
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .dt-summary-guidance{
      margin-top: 12px;
      border-top: 1px solid var(--line);
      padding-top: 12px;
    }

    .dt-summary-h3{
      margin: 0 0 8px 0;
      font-size: 15px;
    }

    .dt-summary-lists{
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .dt-summary-list{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.02);
    }

    .dt-summary-h4{
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--text);
    }

    .dt-summary-ul{
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      line-height: 1.5;
      font-size: 13px;
    }

    .dt-summary-ul li{
      margin: 6px 0;
    }

    .dt-modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }

    .dt-modal-overlay[data-open="true"]{
      display: flex;
    }

    .dt-modal{
      width: min(680px, 100%);
      background: rgba(15,27,51,0.96);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 16px;
      box-shadow: var(--shadow), 0 0 26px rgba(67,167,227,0.14);
      padding: 16px;
    }

    .dt-modal h3{
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .dt-modal p{
      margin: 0 0 10px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }

    .dt-modal .dt-modal-box{
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      background: rgba(0,0,0,0.20);
      padding: 12px;
      margin-top: 10px;
    }

    .dt-modal label{
      display: flex;
      gap: 10px;
      align-items: flex-start;
      color: var(--text);
      font-size: 13px;
      line-height: 1.5;
    }

    .dt-modal input[type="checkbox"]{
      margin-top: 3px;
      accent-color: var(--tidy-orange);
    }

    .dt-modal-actions{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
      justify-content: flex-end;
    }

    .sr-only{
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    @media (min-width: 920px){
      .dt-row{
        grid-template-columns: 1.45fr 1fr;
        gap: 14px;
      }
      .dt-summary-grid{
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .dt-summary-lists{
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px){
      .dt-scale-row{
        grid-template-columns: 1fr;
      }
      .dt-choice{
        min-height: unset;
      }
      .dt-seg button{
        min-width: 0;
        width: 50%;
      }
    }

    @media print{
      body{
        background: #ffffff;
        color: #111827;
        padding: 0;
      }
      .dt-card{
        box-shadow: none;
        border: 1px solid #d1d5db;
      }
      .dt-header{
        background: #ffffff;
        border-bottom: 1px solid #d1d5db;
      }
      .dt-panel, fieldset.dt-item{
        background: #ffffff;
        border-color: #d1d5db;
        box-shadow: none;
      }
      .dt-actions, .dt-seg, .dt-status, .dt-bottom-actions{
        display: none !important;
      }
      textarea.dt-textarea{
        border: 1px solid #d1d5db;
        color: #111827;
        background: #ffffff;
      }
      .dt-bar{
        border: 1px solid #d1d5db;
        background: #f3f4f6;
      }
      .dt-bar > span{
        background: #111827;
      }
      .dt-modal-overlay{
        display: none !important;
      }
    }
  </style>
</head>

<body>
  <main class="dt-container" id="dtMain">
    <section id="distance-travelled" class="dt-card" aria-labelledby="dt-title">
      <header class="dt-header">
        <h1 id="dt-title" class="dt-title">Distance Travelled: a private confidence check-in</h1>

        <p class="dt-intro">
          This is a gentle way to notice your progress. You can use it twice: once at the start (Session 1) and again at the end (Session 6).
          It focuses on what you have <strong>noticed</strong>, <strong>tried</strong>, and <strong>recognised</strong>.
        </p>

        <div class="dt-reassure" role="note" aria-label="Reassurance">
          <strong>This is private, not graded, and you cannot fail.</strong>
          Nothing is sent anywhere unless you choose to send it. If you save, it stays on this device only.
        </div>
      </header>

      <div class="dt-body">
        <div class="dt-row">
          <section class="dt-panel dt-controls" aria-labelledby="dt-setup-title">
            <h2 id="dt-setup-title">Choose your checkpoint</h2>

            <div class="dt-mode" aria-label="Checkpoint mode selector">
              <span><strong>I'm doing:</strong></span>
              <div class="dt-seg" role="group" aria-label="Start or End checkpoint">
                <button type="button" id="dtModeStart" aria-pressed="true">Start of course</button>
                <button type="button" id="dtModeEnd" aria-pressed="false">End of course</button>
              </div>
            </div>

            <p class="dt-hint" id="dt-mode-hint"></p>

            <p class="dt-small">
              How to use the scale: pick the statement that matches how you feel <strong>today</strong>.
              If you are unsure between two, choose the lower one. That keeps this low pressure.
            </p>

            <p class="dt-footer-note">
              Tip: If you want to keep this entirely offline with no saved data, you can still fill it in and use Print to save a PDF.
            </p>
          </section>

          <section class="dt-panel dt-progress" aria-labelledby="dt-progress-title">
            <h2 id="dt-progress-title">Your progress view</h2>

            <div class="dt-scoreline">
              <div class="dt-score" id="dtScoreText">Overall: <strong>0</strong> out of <strong>0</strong></div>
              <div class="dt-score" id="dtScorePct">0%</div>
            </div>

            <div class="dt-bar" aria-label="Overall progress bar">
              <span id="dtBarFill"></span>
            </div>

            <p class="dt-message" id="dtSupportMessage">
              Small changes count. Even noticing a word in the wild is real progress.
            </p>

            <div class="dt-actions" aria-label="Actions">
              <button class="dt-btn primary" type="button" id="dtSaveBtn">Save on this device</button>
              <button class="dt-btn" type="button" id="dtCopyBtn">Copy summary</button>
              <button class="dt-btn" type="button" id="dtDocBtn">Download Word document</button>
              <button class="dt-btn" type="button" id="dtPrintBtn">Print or Save as PDF</button>
              <button class="dt-btn primary" type="button" id="dtSendBtn">Send to Tidy Butt</button>
              <button class="dt-btn danger" type="button" id="dtResetBtn">Reset</button>
            </div>

            <div class="dt-status" id="dtStatus" aria-live="polite"></div>
            <p class="dt-footer-note" id="dtLastSentNote"></p>
          </section>
        </div>

        <form id="dtForm" class="dt-items" novalidate>
          <!-- Items injected by JS -->
        </form>

        <div class="dt-bottom-actions" aria-label="After questions actions">
          <button class="dt-btn primary" type="button" id="dtSaveBottomBtn">Save on this device</button>
          <button class="dt-btn" type="button" id="dtTopBtn">Go to top of page</button>
        </div>

        <section class="dt-panel dt-summary" aria-labelledby="dtSummaryTitle">
          <h2 id="dtSummaryTitle">Your checkpoint summary</h2>
          <p class="dt-small" id="dtSummaryIntro">
            This summary is private to you. It is designed to help you notice progress, not to judge you.
          </p>

          <div class="dt-summary-grid" role="group" aria-label="Summary scores">
            <div class="dt-summary-box" aria-label="Start score box">
              <div class="dt-summary-label">Start of course</div>
              <div class="dt-summary-value" id="dtSummaryStartValue">Not saved yet</div>
              <div class="dt-summary-sub" id="dtSummaryStartSub">Complete and save your Start checkpoint to capture a baseline.</div>
            </div>

            <div class="dt-summary-box" aria-label="End score box">
              <div class="dt-summary-label">End of course</div>
              <div class="dt-summary-value" id="dtSummaryEndValue">Not saved yet</div>
              <div class="dt-summary-sub" id="dtSummaryEndSub">Complete and save your End checkpoint to see distance travelled.</div>
            </div>

            <div class="dt-summary-box" aria-label="Distance travelled box">
              <div class="dt-summary-label">Distance travelled</div>
              <div class="dt-summary-value" id="dtSummaryDistanceValue">Save both checkpoints to compare.</div>
              <div class="dt-summary-sub" id="dtSummaryDistanceSub">Small changes count, including noticing and trying.</div>
            </div>
          </div>

          <div class="dt-summary-guidance" aria-label="Guidance">
            <h3 class="dt-summary-h3" id="dtGuidanceTitle">Support and next steps</h3>
            <p class="dt-message" id="dtGuidanceMessage"></p>

            <div class="dt-summary-lists" id="dtGuidanceLists" hidden>
              <div class="dt-summary-list">
                <h4 class="dt-summary-h4">Strengths you can lean on</h4>
                <ul class="dt-summary-ul" id="dtStrengthsList"></ul>
              </div>

              <div class="dt-summary-list">
                <h4 class="dt-summary-h4">Confidence to expand next</h4>
                <ul class="dt-summary-ul" id="dtNextStepsList"></ul>
              </div>
            </div>

            <p class="dt-footer-note" id="dtGuidanceFooter">
              Reminder: this is private, not graded, and you cannot fail. Your scores are simply a way to notice what is changing over time.
            </p>
          </div>
        </section>
      </div>
    </section>
  </main>

  <div class="dt-modal-overlay" id="dtModalOverlay" data-open="false">
    <div class="dt-modal" role="dialog" aria-modal="true" aria-labelledby="dtModalTitle">
      <h3 id="dtModalTitle">Send your checkpoint scores to Tidy Butt</h3>
      <p>
        This is optional. It helps us evaluate the course.
        Please do not include personal data such as names, contact details, addresses, or anything that identifies you or someone else.
      </p>

      <div class="dt-modal-box">
        <label for="dtConsent">
          <input type="checkbox" id="dtConsent" />
          <span>
            I understand this sends my scores and notes from this tool.
            I will not include personal data.
          </span>
        </label>
      </div>

      <div class="dt-modal-actions">
        <button class="dt-btn" type="button" id="dtModalCancel">Cancel</button>
        <button class="dt-btn primary" type="button" id="dtModalSend">Send now</button>
      </div>

      <p class="dt-footer-note" style="margin-top:10px;">
        If sending fails, you can download the Word document and send it later if you choose.
      </p>
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      /* =========================
         CONFIG
         ========================= */
      var APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzu-Suutn_00ELOAjaU6RiQNEO0QPQinn89mCDu5hf6azw82TSiK9rPS3hc4hUOd9jGLg/exec";

      var STORAGE_KEYS = {
        start: "tidybutt_ycc_distanceTravelled_v1_start",
        end: "tidybutt_ycc_distanceTravelled_v1_end",
        anonId: "tidybutt_ycc_distanceTravelled_v1_anonId",
        lastSentAt: "tidybutt_ycc_distanceTravelled_v1_lastSentAt"
      };

      var ITEMS = [
        { id: "listen_general", title: "Listening: I feel ok listening to Welsh, even if I only catch a few words.", why: "Why this matters: catching a word or two is real listening progress. You do not need full sentences to be improving." },
        { id: "listen_audio", title: "Listening with audio: I feel confident using audio (voice notes, clips, or live audio) to learn Welsh.", why: "Why this matters: audio helps your ear tune in. Replaying small clips builds familiarity without pressure." },
        { id: "speak_one_word", title: "Speaking: I feel ok saying a word or short phrase out loud (even if my accent feels unsure).", why: "Why this matters: speaking is physical practice. Your mouth and confidence both improve through tiny attempts." },
        { id: "speak_non_welsh_speaker", title: "Speaking with other learners: I feel ok speaking Welsh with someone who is also learning (not a confident Welsh speaker).", why: "Why this matters: learner-to-learner practice is low pressure and builds fluency through shared effort." },
        { id: "speak_confident_welsh_speaker", title: "Speaking with a confident Welsh speaker: I feel ok trying Welsh with someone who speaks it confidently.", why: "Why this matters: this is a common fear. Even one brave attempt builds real-world confidence." },
        { id: "reading_recognise", title: "Reading: I can recognise familiar Welsh words or patterns when I see them.", why: "Why this matters: recognition is the foundation of reading. You are training your brain to spot Welsh quickly." },
        { id: "writing_message", title: "Writing: I feel ok writing a short Welsh message (even if it is simple, and I use a cheat sheet).", why: "Why this matters: writing slows language down in a helpful way. Simple messages are still genuine Welsh use." },
        { id: "public_space", title: "Public spaces: I feel ok using Welsh in a public setting (shop, caf√©, workplace, or community space).", why: "Why this matters: real-life use is the goal. A small moment in public is a big confidence milestone." }
      ];

      var SCALE = [
        { v: 0, a: "Not yet" },
        { v: 1, a: "Just starting" },
        { v: 2, a: "A bit" },
        { v: 3, a: "Mostly" },
        { v: 4, a: "Yes, comfortably" }
      ];

      var MAX_PER_ITEM = 4;
      var MAX_TOTAL = ITEMS.length * MAX_PER_ITEM;

      var main = document.getElementById("dtMain");
      var form = document.getElementById("dtForm");

      var modeStartBtn = document.getElementById("dtModeStart");
      var modeEndBtn = document.getElementById("dtModeEnd");
      var modeHint = document.getElementById("dt-mode-hint");

      var scoreText = document.getElementById("dtScoreText");
      var scorePct = document.getElementById("dtScorePct");
      var barFill = document.getElementById("dtBarFill");
      var supportMsg = document.getElementById("dtSupportMessage");

      var summaryStartValue = document.getElementById("dtSummaryStartValue");
      var summaryEndValue = document.getElementById("dtSummaryEndValue");
      var summaryDistanceValue = document.getElementById("dtSummaryDistanceValue");
      var summaryStartSub = document.getElementById("dtSummaryStartSub");
      var summaryEndSub = document.getElementById("dtSummaryEndSub");
      var summaryDistanceSub = document.getElementById("dtSummaryDistanceSub");

      var guidanceMessage = document.getElementById("dtGuidanceMessage");
      var guidanceLists = document.getElementById("dtGuidanceLists");
      var strengthsList = document.getElementById("dtStrengthsList");
      var nextStepsList = document.getElementById("dtNextStepsList");

      var saveBtn = document.getElementById("dtSaveBtn");
      var saveBottomBtn = document.getElementById("dtSaveBottomBtn");
      var topBtn = document.getElementById("dtTopBtn");

      var copyBtn = document.getElementById("dtCopyBtn");
      var docBtn = document.getElementById("dtDocBtn");
      var printBtn = document.getElementById("dtPrintBtn");
      var sendBtn = document.getElementById("dtSendBtn");
      var resetBtn = document.getElementById("dtResetBtn");
      var statusEl = document.getElementById("dtStatus");
      var lastSentNote = document.getElementById("dtLastSentNote");

      var modalOverlay = document.getElementById("dtModalOverlay");
      var modalCancel = document.getElementById("dtModalCancel");
      var modalSend = document.getElementById("dtModalSend");
      var consentBox = document.getElementById("dtConsent");

      var mode = "start";
      var lastFocusEl = null;

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function safeParse(jsonStr) {
        try { return JSON.parse(jsonStr); } catch (e) { return null; }
      }

      function nowISO() { return new Date().toISOString(); }

      function formatLocalTime(iso) {
        try {
          var d = new Date(iso);
          if (isNaN(d.getTime())) return "";
          return d.toLocaleString("en-GB", { year: "numeric", month: "short", day: "2-digit", hour: "2-digit", minute: "2-digit" });
        } catch (e) { return ""; }
      }

      function setStatus(msg, isError) {
        if (!msg) { statusEl.textContent = ""; return; }
        statusEl.innerHTML = isError ? "<strong>Note:</strong> " + escapeHtml(msg) : escapeHtml(msg);
      }

      function setLastSentNoteFromStorage() {
        var iso = localStorage.getItem(STORAGE_KEYS.lastSentAt);
        if (!iso) { lastSentNote.textContent = ""; return; }
        var nice = formatLocalTime(iso);
        lastSentNote.textContent = nice ? ("Last sent (queued): " + nice + " (stored on this device only)") : "";
      }

      function getAnonId() {
        var existing = localStorage.getItem(STORAGE_KEYS.anonId);
        if (existing) return existing;
        var id = "anon_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
        localStorage.setItem(STORAGE_KEYS.anonId, id);
        return id;
      }

      function readSnapshot(which) {
        var key = which === "start" ? STORAGE_KEYS.start : STORAGE_KEYS.end;
        var raw = localStorage.getItem(key);
        if (!raw) return null;
        var parsed = safeParse(raw);
        if (!parsed || typeof parsed !== "object") return null;
        return parsed;
      }

      function writeSnapshot(which, data) {
        var key = which === "start" ? STORAGE_KEYS.start : STORAGE_KEYS.end;
        localStorage.setItem(key, JSON.stringify(data));
      }

      function clearAllSnapshots() {
        localStorage.removeItem(STORAGE_KEYS.start);
        localStorage.removeItem(STORAGE_KEYS.end);
      }

      function computeTotal(scores) {
        var total = 0;
        for (var i = 0; i < ITEMS.length; i++) {
          var item = ITEMS[i];
          var v = scores[item.id];
          if (v === 0 || v) total += Number(v);
        }
        return total;
      }

      function scoreToText(total) {
        var pct = MAX_TOTAL === 0 ? 0 : Math.round((total / MAX_TOTAL) * 100);
        return total + "/" + MAX_TOTAL + " (" + pct + "%)";
      }

      function categoriseForGuidance(itemId) {
        if (itemId.indexOf("listen") === 0) return "Listening";
        if (itemId.indexOf("speak") === 0) return "Speaking";
        if (itemId.indexOf("reading") === 0) return "Reading";
        if (itemId.indexOf("writing") === 0) return "Writing";
        if (itemId.indexOf("public") === 0) return "Using Welsh in public";
        return "Welsh confidence";
      }

      function categoryTagText(itemId) {
        if (itemId.indexOf("listen") === 0) return "Listening";
        if (itemId.indexOf("speak") === 0) return "Speaking";
        if (itemId.indexOf("reading") === 0) return "Reading";
        if (itemId.indexOf("writing") === 0) return "Writing";
        if (itemId.indexOf("public") === 0) return "Real-life use";
        return "Confidence";
      }

      function buildForm() {
        var html = "";
        for (var i = 0; i < ITEMS.length; i++) {
          var item = ITEMS[i];
          var legendId = "dt-legend-" + item.id;
          var whyId = "dt-why-" + item.id;
          var notesId = "dt-notes-" + item.id;

          html += "<fieldset class='dt-item' aria-labelledby='" + legendId + "' aria-describedby='" + whyId + "'>";
          html += "  <legend class='dt-legend' id='" + legendId + "'>" + escapeHtml((i + 1) + ". " + item.title) + "</legend>";
          html += "  <p class='dt-why' id='" + whyId + "'>" + escapeHtml(item.why) + "</p>";
          html += "  <div class='dt-tag' aria-label='Skill area'>" + escapeHtml(categoryTagText(item.id)) + "</div>";

          html += "  <div class='dt-scale' role='group' aria-label='Confidence scale'>";
          html += "    <div class='dt-scale-row'>";

          for (var s = 0; s < SCALE.length; s++) {
            var opt = SCALE[s];
            var inputId = "dt-" + item.id + "-" + opt.v;
            var name = "score_" + item.id;

            html += "      <label class='dt-choice' for='" + inputId + "'>";
            html += "        <input type='radio' id='" + inputId + "' name='" + name + "' value='" + opt.v + "' aria-label='" + escapeHtml(opt.a) + " (" + opt.v + ")' />";
            html += "        <span class='dt-num'>" + opt.v + "</span>";
            html += "        <span class='dt-anchor'>" + escapeHtml(opt.a) + "</span>";
            html += "      </label>";
          }

          html += "    </div>";
          html += "  </div>";

          html += "  <div class='dt-notes'>";
          html += "    <label for='" + notesId + "'>Notes to self (private, optional)</label>";
          html += "    <textarea class='dt-textarea' id='" + notesId + "' name='note_" + item.id + "' placeholder='Do not include personal data. For example: where I noticed Welsh, what felt easier, what I want to try next.'></textarea>";
          html += "  </div>";
          html += "</fieldset>";
        }

        form.innerHTML = html;
      }

      function getCurrentResponses() {
        var scores = {};
        var notes = {};
        for (var i = 0; i < ITEMS.length; i++) {
          var item = ITEMS[i];
          var scoreName = "score_" + item.id;
          var selected = form.querySelector("input[name='" + scoreName + "']:checked");
          if (selected) scores[item.id] = Number(selected.value);

          var noteEl = form.querySelector("textarea[name='note_" + item.id + "']");
          notes[item.id] = noteEl ? String(noteEl.value || "") : "";
        }
        return { scores: scores, notes: notes };
      }

      function setResponsesFromSnapshot(snapshot) {
        if (!snapshot) return;

        for (var i = 0; i < ITEMS.length; i++) {
          var item = ITEMS[i];

          var val = snapshot.scores ? snapshot.scores[item.id] : undefined;
          var radios = form.querySelectorAll("input[name='score_" + item.id + "']");
          radios.forEach(function (r) { r.checked = false; });

          if (val === 0 || val) {
            var input = form.querySelector("input[name='score_" + item.id + "'][value='" + val + "']");
            if (input) input.checked = true;
          }

          var noteEl = form.querySelector("textarea[name='note_" + item.id + "']");
          if (noteEl) {
            var n = snapshot.notes && typeof snapshot.notes[item.id] === "string" ? snapshot.notes[item.id] : "";
            noteEl.value = n;
          }
        }
      }

      function updateProgressUI() {
        var current = getCurrentResponses();
        var answeredCount = Object.keys(current.scores).length;
        var total = computeTotal(current.scores);
        var pct = MAX_TOTAL === 0 ? 0 : Math.round((total / MAX_TOTAL) * 100);

        scoreText.innerHTML = "Overall: <strong>" + total + "</strong> out of <strong>" + MAX_TOTAL + "</strong>";
        scorePct.textContent = pct + "%";
        barFill.style.width = pct + "%";

        if (answeredCount === 0) {
          supportMsg.textContent = "Start anywhere. One item is enough for today.";
        } else if (answeredCount < ITEMS.length) {
          supportMsg.textContent = "Nice. You have started. You can leave any item blank if it does not fit today.";
        } else {
          if (pct <= 25) supportMsg.textContent = "This looks like an honest baseline. Being at the start is expected and welcome here.";
          else if (pct <= 55) supportMsg.textContent = "You are building foundations. Keep noticing small wins. They add up.";
          else if (pct <= 80) supportMsg.textContent = "You have lots to work with already. The course can help make it feel more automatic.";
          else supportMsg.textContent = "You are feeling very ready. You can use the course to stay relaxed and make it social.";
        }

        renderSummaryCard();
      }

      function buildGuidanceFromSnapshot(snap) {
        var strengths = [];
        var nextSteps = [];

        for (var i = 0; i < ITEMS.length; i++) {
          var item = ITEMS[i];
          var v = Number((snap.scores || {})[item.id]);
          if (!Number.isFinite(v)) continue;

          if (v >= 3) strengths.push(item);
          else nextSteps.push(item);
        }

        return { strengths: strengths.slice(0, 5), nextSteps: nextSteps.slice(0, 5) };
      }

      function renderSummaryCard() {
        var startSnap = readSnapshot("start");
        var endSnap = readSnapshot("end");

        var current = getCurrentResponses();
        var currentTotal = computeTotal(current.scores);

        var startTotal = startSnap ? computeTotal(startSnap.scores || {}) : null;
        var endTotal = endSnap ? computeTotal(endSnap.scores || {}) : null;

        if (startTotal === null) {
          summaryStartValue.textContent = (mode === "start" && Object.keys(current.scores).length > 0)
            ? scoreToText(currentTotal) + " (not saved)"
            : "Not saved yet";
          summaryStartSub.textContent = "
