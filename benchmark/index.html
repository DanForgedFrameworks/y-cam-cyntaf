<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tidy Butt: Y Cam Cyntaf | Distance Travelled (Confidence Check-in)</title>

  <style>
    :root{
      --bg: #0f172a;
      --card: #0b1220;
      --panel: #0f1b33;
      --text: #e5e7eb;
      --muted: #cbd5e1;
      --quiet: #94a3b8;
      --line: rgba(255,255,255,0.12);
      --focus: #fbbf24;
      --accent: #60a5fa;
      --good: #34d399;
      --warn: #fbbf24;
      --soft: rgba(96,165,250,0.15);
      --danger: #fb7185;
      --radius: 16px;
      --shadow: 0 18px 40px rgba(0,0,0,0.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }

    body{
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 500px at 12% 10%, rgba(96,165,250,0.18), transparent 60%),
        radial-gradient(900px 500px at 88% 20%, rgba(52,211,153,0.10), transparent 55%),
        linear-gradient(180deg, #070b14, var(--bg));
      min-height: 100vh;
      padding: clamp(14px, 3vw, 28px);
    }

    .dt-container{
      width: min(980px, 100%);
      margin: 0 auto;
    }

    .dt-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .dt-header{
      padding: clamp(16px, 3.2vw, 26px);
      background: linear-gradient(180deg, rgba(96,165,250,0.15), transparent 70%);
      border-bottom: 1px solid var(--line);
    }

    .dt-title{
      margin: 0 0 8px 0;
      font-size: clamp(20px, 2.6vw, 28px);
      letter-spacing: 0.2px;
      line-height: 1.2;
    }

    .dt-intro{
      margin: 0;
      color: var(--muted);
      line-height: 1.55;
      max-width: 70ch;
    }

    .dt-reassure{
      margin-top: 12px;
      padding: 12px 14px;
      background: rgba(52,211,153,0.10);
      border: 1px solid rgba(52,211,153,0.22);
      border-radius: 12px;
      color: var(--text);
    }

    .dt-reassure strong{ color: #bbf7d0; }

    .dt-body{
      padding: clamp(14px, 3vw, 24px);
      display: grid;
      gap: 14px;
    }

    .dt-row{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: start;
    }

    .dt-panel{
      background: rgba(15,27,51,0.55);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
    }

    .dt-panel h2{
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .dt-small{
      margin: 0;
      color: var(--quiet);
      font-size: 13px;
      line-height: 1.5;
    }

    .dt-controls{
      display: grid;
      gap: 12px;
    }

    .dt-mode{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .dt-seg{
      display: inline-flex;
      border: 1px solid var(--line);
      border-radius: 999px;
      overflow: hidden;
      background: rgba(255,255,255,0.03);
    }

    .dt-seg button{
      appearance: none;
      border: 0;
      background: transparent;
      color: var(--text);
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 650;
      letter-spacing: 0.2px;
      min-width: 110px;
    }

    .dt-seg button[aria-pressed="true"]{
      background: rgba(96,165,250,0.22);
      border-right: 1px solid rgba(255,255,255,0.08);
      border-left: 1px solid rgba(255,255,255,0.08);
    }

    .dt-hint{
      margin-top: 8px;
      color: var(--quiet);
      font-size: 13px;
      line-height: 1.45;
    }

    .dt-items{
      display: grid;
      gap: 12px;
    }

    fieldset.dt-item{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      margin: 0;
      background: rgba(255,255,255,0.02);
    }

    fieldset.dt-item:focus-within{
      outline: 3px solid rgba(251,191,36,0.35);
      outline-offset: 2px;
    }

    /* Visual variation: alternating item styling */
    fieldset.dt-item:nth-of-type(odd){
      background: rgba(255,255,255,0.025);
      border-color: rgba(96,165,250,0.18);
    }

    fieldset.dt-item:nth-of-type(even){
      background: rgba(52,211,153,0.045);
      border-color: rgba(52,211,153,0.18);
    }

    /* Optional: small category tag */
    .dt-tag{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      color: var(--muted);
      margin-top: 8px;
      width: fit-content;
    }

    .dt-legend{
      padding: 0 6px;
      font-weight: 750;
      line-height: 1.35;
    }

    .dt-why{
      margin: 6px 0 10px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .dt-scale{
      display: grid;
      gap: 10px;
    }

    .dt-scale-row{
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
    }

    .dt-choice{
      position: relative;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 10px 12px;
      background: rgba(15,27,51,0.35);
      min-height: 60px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      justify-content: space-between;
    }

    .dt-choice input{
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .dt-choice .dt-num{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--quiet);
    }

    .dt-choice .dt-anchor{
      font-weight: 700;
      font-size: 13px;
      line-height: 1.25;
      color: var(--text);
    }

    .dt-choice:has(input:focus-visible){
      outline: 3px solid rgba(251,191,36,0.50);
      outline-offset: 2px;
    }

    .dt-choice:has(input:checked){
      border-color: rgba(96,165,250,0.55);
      background: rgba(96,165,250,0.16);
    }

    .dt-notes{
      margin-top: 10px;
      display: grid;
      gap: 6px;
    }

    .dt-notes label{
      font-size: 13px;
      font-weight: 650;
      color: var(--muted);
    }

    textarea.dt-textarea{
      width: 100%;
      resize: vertical;
      min-height: 68px;
      max-height: 220px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      font-family: var(--sans);
      line-height: 1.45;
    }

    textarea.dt-textarea:focus-visible{
      outline: 3px solid rgba(251,191,36,0.55);
      outline-offset: 2px;
    }

    .dt-progress{
      display: grid;
      gap: 12px;
    }

    .dt-scoreline{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: baseline;
      justify-content: space-between;
    }

    .dt-scoreline .dt-score{
      font-size: 14px;
      color: var(--muted);
    }

    .dt-scoreline .dt-score strong{
      color: var(--text);
      font-size: 16px;
    }

    .dt-bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      overflow: hidden;
    }

    .dt-bar > span{
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(96,165,250,0.7), rgba(52,211,153,0.65));
      border-radius: 999px;
      transition: width 240ms ease;
    }

    .dt-message{
      margin: 0;
      color: var(--muted);
      line-height: 1.55;
      font-size: 13px;
    }

    .dt-actions{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
    }

    .dt-btn{
      appearance: none;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 750;
      letter-spacing: 0.2px;
      font-size: 13px;
    }

    .dt-btn.primary{
      background: rgba(96,165,250,0.22);
      border-color: rgba(96,165,250,0.35);
    }

    .dt-btn.danger{
      background: rgba(251,113,133,0.14);
      border-color: rgba(251,113,133,0.28);
    }

    .dt-btn:focus-visible{
      outline: 3px solid rgba(251,191,36,0.55);
      outline-offset: 2px;
    }

    .dt-status{
      min-height: 1.2em;
      color: var(--quiet);
      font-size: 13px;
      line-height: 1.4;
    }

    .dt-status strong{ color: var(--text); }

    .dt-footer-note{
      color: var(--quiet);
      font-size: 12px;
      line-height: 1.45;
      margin: 0;
    }

    .sr-only{
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    @media (min-width: 920px){
      .dt-row{
        grid-template-columns: 1.45fr 1fr;
        gap: 14px;
      }
    }

    @media (max-width: 640px){
      .dt-scale-row{
        grid-template-columns: 1fr;
      }
      .dt-choice{
        min-height: unset;
      }
      .dt-seg button{
        min-width: 0;
        width: 50%;
      }
    }

    /* Bottom actions after questions */
    .dt-bottom-actions{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
      margin-top: 4px;
    }

    .dt-bottom-actions .dt-btn{
      min-width: 160px;
    }

    /* Summary card */
    .dt-summary{
      margin-top: 4px;
    }

    .dt-summary-grid{
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .dt-summary-box{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.02);
    }

    .dt-summary-label{
      font-size: 12px;
      color: var(--quiet);
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }

    .dt-summary-value{
      margin-top: 6px;
      font-weight: 850;
      font-size: 16px;
      line-height: 1.2;
      color: var(--text);
    }

    .dt-summary-sub{
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .dt-summary-guidance{
      margin-top: 12px;
      border-top: 1px solid var(--line);
      padding-top: 12px;
    }

    .dt-summary-h3{
      margin: 0 0 8px 0;
      font-size: 15px;
    }

    .dt-summary-lists{
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .dt-summary-list{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.02);
    }

    .dt-summary-h4{
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--text);
    }

    .dt-summary-ul{
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      line-height: 1.5;
      font-size: 13px;
    }

    .dt-summary-ul li{
      margin: 6px 0;
    }

    @media (min-width: 920px){
      .dt-summary-grid{
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .dt-summary-lists{
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    /* Modal (less transparent, no aria-hidden focus issues) */
    .dt-modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }

    .dt-modal-overlay[data-open="true"]{
      display: flex;
    }

    .dt-modal{
      width: min(680px, 100%);
      background: rgba(15,27,51,0.96);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .dt-modal h3{
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .dt-modal p{
      margin: 0 0 10px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }

    .dt-modal .dt-modal-box{
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      background: rgba(0,0,0,0.20);
      padding: 12px;
      margin-top: 10px;
    }

    .dt-modal label{
      display: flex;
      gap: 10px;
      align-items: flex-start;
      color: var(--text);
      font-size: 13px;
      line-height: 1.5;
    }

    .dt-modal input[type="checkbox"]{
      margin-top: 3px;
      accent-color: var(--accent);
    }

    .dt-modal-actions{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
      justify-content: flex-end;
    }

    /* Print friendly */
    @media print{
      body{
        background: #ffffff;
        color: #111827;
        padding: 0;
      }
      .dt-card{
        box-shadow: none;
        border: 1px solid #d1d5db;
      }
      .dt-header{
        background: #ffffff;
        border-bottom: 1px solid #d1d5db;
      }
      .dt-panel, fieldset.dt-item{
        background: #ffffff;
        border-color: #d1d5db;
      }
      .dt-actions, .dt-seg, .dt-status, .dt-bottom-actions{
        display: none !important;
      }
      textarea.dt-textarea{
        border: 1px solid #d1d5db;
        color: #111827;
        background: #ffffff;
      }
      .dt-bar{
        border: 1px solid #d1d5db;
        background: #f3f4f6;
      }
      .dt-bar > span{
        background: #111827;
      }
      .dt-modal-overlay{
        display: none !important;
      }
    }
  </style>
</head>

<body>
  <main class="dt-container" id="dtMain">
    <section id="distance-travelled" class="dt-card" aria-labelledby="dt-title">
      <header class="dt-header">
        <h1 id="dt-title" class="dt-title">Distance Travelled: a private confidence check-in</h1>

        <p class="dt-intro">
          This is a gentle way to notice your progress. You can use it twice: once at the start (Session 1) and again at the end (Session 6).
          It focuses on what you have <strong>noticed</strong>, <strong>tried</strong>, and <strong>recognised</strong>.
        </p>

        <div class="dt-reassure" role="note" aria-label="Reassurance">
          <strong>This is private, not graded, and you cannot fail.</strong>
          Nothing is sent anywhere unless you choose to send it. If you save, it stays on this device only.
        </div>
      </header>

      <div class="dt-body">
        <div class="dt-row">
          <section class="dt-panel dt-controls" aria-labelledby="dt-setup-title">
            <h2 id="dt-setup-title">Choose your checkpoint</h2>

            <div class="dt-mode" aria-label="Checkpoint mode selector">
              <span><strong>I'm doing:</strong></span>
              <div class="dt-seg" role="group" aria-label="Start or End checkpoint">
                <button type="button" id="dtModeStart" aria-pressed="true">Start of course</button>
                <button type="button" id="dtModeEnd" aria-pressed="false">End of course</button>
              </div>
            </div>

            <p class="dt-hint" id="dt-mode-hint"></p>

            <p class="dt-small">
              How to use the scale: pick the statement that matches how you feel <strong>today</strong>.
              If you are unsure between two, choose the lower one. That keeps this low pressure.
            </p>

            <p class="dt-footer-note">
              Tip: If you want to keep this entirely offline with no saved data, you can still fill it in and use Print to save a PDF.
            </p>
          </section>

          <section class="dt-panel dt-progress" aria-labelledby="dt-progress-title">
            <h2 id="dt-progress-title">Your progress view</h2>

            <div class="dt-scoreline">
              <div class="dt-score" id="dtScoreText">Overall: <strong>0</strong> out of <strong>0</strong></div>
              <div class="dt-score" id="dtScorePct">0%</div>
            </div>

            <div class="dt-bar" aria-label="Overall progress bar">
              <span id="dtBarFill"></span>
            </div>

            <p class="dt-message" id="dtSupportMessage">
              Small changes count. Even noticing a word in the wild is real progress.
            </p>

            <div class="dt-actions" aria-label="Actions">
              <button class="dt-btn primary" type="button" id="dtSaveBtn">Save on this device</button>
              <button class="dt-btn" type="button" id="dtCopyBtn">Copy summary</button>
              <button class="dt-btn" type="button" id="dtDocBtn">Download Word document</button>
              <button class="dt-btn" type="button" id="dtPrintBtn">Print or Save as PDF</button>
              <button class="dt-btn" type="button" id="dtSendBtn">Send to Tidy Butt</button>
              <button class="dt-btn danger" type="button" id="dtResetBtn">Reset</button>
            </div>

            <div class="dt-status" id="dtStatus" aria-live="polite"></div>
            <p class="dt-footer-note" id="dtLastSentNote"></p>
          </section>
        </div>

        <form id="dtForm" class="dt-items" novalidate>
          <!-- Items injected by JS -->
        </form>

        <div class="dt-bottom-actions" aria-label="After questions actions">
          <button class="dt-btn primary" type="button" id="dtSaveBottomBtn">Save on this device</button>
          <button class="dt-btn" type="button" id="dtTopBtn">Go to top of page</button>
        </div>

        <section class="dt-panel dt-summary" aria-labelledby="dtSummaryTitle">
          <h2 id="dtSummaryTitle">Your checkpoint summary</h2>
          <p class="dt-small" id="dtSummaryIntro">
            This summary is private to you. It is designed to help you notice progress, not to judge you.
          </p>

          <div class="dt-summary-grid" role="group" aria-label="Summary scores">
            <div class="dt-summary-box" aria-label="Start score box">
              <div class="dt-summary-label">Start of course</div>
              <div class="dt-summary-value" id="dtSummaryStartValue">Not saved yet</div>
              <div class="dt-summary-sub" id="dtSummaryStartSub">Complete and save your Start checkpoint to capture a baseline.</div>
            </div>

            <div class="dt-summary-box" aria-label="End score box">
              <div class="dt-summary-label">End of course</div>
              <div class="dt-summary-value" id="dtSummaryEndValue">Not saved yet</div>
              <div class="dt-summary-sub" id="dtSummaryEndSub">Complete and save your End checkpoint to see distance travelled.</div>
            </div>

            <div class="dt-summary-box" aria-label="Distance travelled box">
              <div class="dt-summary-label">Distance travelled</div>
              <div class="dt-summary-value" id="dtSummaryDistanceValue">Save both checkpoints to compare.</div>
              <div class="dt-summary-sub" id="dtSummaryDistanceSub">Small changes count, including noticing and trying.</div>
            </div>
          </div>

          <div class="dt-summary-guidance" aria-label="Guidance">
            <h3 class="dt-summary-h3" id="dtGuidanceTitle">Support and next steps</h3>
            <p class="dt-message" id="dtGuidanceMessage"></p>

            <div class="dt-summary-lists" id="dtGuidanceLists" hidden>
              <div class="dt-summary-list">
                <h4 class="dt-summary-h4">Strengths you can lean on</h4>
                <ul class="dt-summary-ul" id="dtStrengthsList"></ul>
              </div>

              <div class="dt-summary-list">
                <h4 class="dt-summary-h4">Confidence to expand next</h4>
                <ul class="dt-summary-ul" id="dtNextStepsList"></ul>
              </div>
            </div>

            <p class="dt-footer-note" id="dtGuidanceFooter">
              Reminder: this is private, not graded, and you cannot fail. Your scores are simply a way to notice what is changing over time.
            </p>
          </div>
        </section>
      </div>
    </section>
  </main>

  <!-- Send modal -->
  <div class="dt-modal-overlay" id="dtModalOverlay" data-open="false">
    <div class="dt-modal" role="dialog" aria-modal="true" aria-labelledby="dtModalTitle">
      <h3 id="dtModalTitle">Send your checkpoint scores to Tidy Butt</h3>
      <p>
        This is optional. It helps us evaluate the course.
        Please do not include personal data such as names, contact details, addresses, or anything that identifies you or someone else.
      </p>

      <div class="dt-modal-box">
        <label for="dtConsent">
          <input type="checkbox" id="dtConsent" />
          <span>
            I understand this sends my scores and notes from this tool.
            I will not include personal data.
          </span>
        </label>
      </div>

      <div class="dt-modal-actions">
        <button class="dt-btn" type="button" id="dtModalCancel">Cancel</button>
        <button class="dt-btn primary" type="button" id="dtModalSend">Send now</button>
      </div>

      <p class="dt-footer-note" style="margin-top:10px;">
        If sending fails, you can download the Word document and send it later if you choose.
      </p>
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      /* =========================
         CONFIG
         ========================= */

      // Put your NEW Apps Script Web App URL (/exec) here.
      // Replace the value below with your correct URL.
      var APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzu-Suutn_00ELOAjaU6RiQNEO0QPQinn89mCDu5hf6azw82TSiK9rPS3hc4hUOd9jGLg/exec";

      /* =========================
         Local storage keys
         ========================= */
      var STORAGE_KEYS = {
        start: "tidybutt_ycc_distanceTravelled_v1_start",
        end: "tidybutt_ycc_distanceTravelled_v1_end",
        anonId: "tidybutt_ycc_distanceTravelled_v1_anonId",
        lastSentAt: "tidybutt_ycc_distanceTravelled_v1_lastSentAt"
      };

      /* =========================
         Items (Welsh confidence)
         ========================= */
      var ITEMS = [
        {
          id: "listen_general",
          title: "Listening: I feel ok listening to Welsh, even if I only catch a few words.",
          why: "Why this matters: catching a word or two is real listening progress. You do not need full sentences to be improving."
        },
        {
          id: "listen_audio",
          title: "Listening with audio: I feel confident using audio (voice notes, clips, or live audio) to learn Welsh.",
          why: "Why this matters: audio helps your ear tune in. Replaying small clips builds familiarity without pressure."
        },
        {
          id: "speak_one_word",
          title: "Speaking: I feel ok saying a word or short phrase out loud (even if my accent feels unsure).",
          why: "Why this matters: speaking is physical practice. Your mouth and confidence both improve through tiny attempts."
        },
        {
          id: "speak_non_welsh_speaker",
          title: "Speaking with other learners: I feel ok speaking Welsh with someone who is also learning (not a confident Welsh speaker).",
          why: "Why this matters: learner-to-learner practice is low pressure and builds fluency through shared effort."
        },
        {
          id: "speak_confident_welsh_speaker",
          title: "Speaking with a confident Welsh speaker: I feel ok trying Welsh with someone who speaks it confidently.",
          why: "Why this matters: this is a common fear. Even one brave attempt builds real-world confidence."
        },
        {
          id: "reading_recognise",
          title: "Reading: I can recognise familiar Welsh words or patterns when I see them.",
          why: "Why this matters: recognition is the foundation of reading. You are training your brain to spot Welsh quickly."
        },
        {
          id: "writing_message",
          title: "Writing: I feel ok writing a short Welsh message (even if it is simple, and I use a cheat sheet).",
          why: "Why this matters: writing slows language down in a helpful way. Simple messages are still genuine Welsh use."
        },
        {
          id: "public_space",
          title: "Public spaces: I feel ok using Welsh in a public setting (shop, caf√©, workplace, or community space).",
          why: "Why this matters: real-life use is the goal. A small moment in public is a big confidence milestone."
        }
      ];

      var SCALE = [
        { v: 0, a: "Not yet" },
        { v: 1, a: "Just starting" },
        { v: 2, a: "A bit" },
        { v: 3, a: "Mostly" },
        { v: 4, a: "Yes, comfortably" }
      ];

      var MAX_PER_ITEM = 4;
      var MAX_TOTAL = ITEMS.length * MAX_PER_ITEM;

      /* =========================
         Elements
         ========================= */
      var main = document.getElementById("dtMain");
      var form = document.getElementById("dtForm");

      var modeStartBtn = document.getElementById("dtModeStart");
      var modeEndBtn = document.getElementById("dtModeEnd");
      var modeHint = document.getElementById("dt-mode-hint");

      var scoreText = document.getElementById("dtScoreText");
      var scorePct = document.getElementById("dtScorePct");
      var barFill = document.getElementById("dtBarFill");
      var supportMsg = document.getElementById("dtSupportMessage");

      var summaryStartValue = document.getElementById("dtSummaryStartValue");
      var summaryEndValue = document.getElementById("dtSummaryEndValue");
      var summaryDistanceValue = document.getElementById("dtSummaryDistanceValue");
      var summaryStartSub = document.getElementById("dtSummaryStartSub");
      var summaryEndSub = document.getElementById("dtSummaryEndSub");
      var summaryDistanceSub = document.getElementById("dtSummaryDistanceSub");

      var guidanceMessage = document.getElementById("dtGuidanceMessage");
      var guidanceLists = document.getElementById("dtGuidanceLists");
      var strengthsList = document.getElementById("dtStrengthsList");
      var nextStepsList = document.getElementById("dtNextStepsList");

      var saveBtn = document.getElementById("dtSaveBtn");
      var saveBottomBtn = document.getElementById("dtSaveBottomBtn");
      var topBtn = document.getElementById("dtTopBtn");

      var copyBtn = document.getElementById("dtCopyBtn");
      var docBtn = document.getElementById("dtDocBtn");
      var printBtn = document.getElementById("dtPrintBtn");
      var sendBtn = document.getElementById("dtSendBtn");
      var resetBtn = document.getElementById("dtResetBtn");
      var statusEl = document.getElementById("dtStatus");
      var lastSentNote = document.getElementById("dtLastSentNote");

      // Modal
      var modalOverlay = document.getElementById("dtModalOverlay");
      var modalCancel = document.getElementById("dtModalCancel");
      var modalSend = document.getElementById("dtModalSend");
      var consentBox = document.getElementById("dtConsent");

      /* =========================
         State
         ========================= */
      var mode = "start";
      var lastFocusEl = null;

      /* =========================
         Helpers
         ========================= */
      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function safeParse(jsonStr) {
        try { return JSON.parse(jsonStr); } catch (e) { return null; }
      }

      function nowISO() {
        return new Date().toISOString();
      }

      function formatLocalTime(iso) {
        try {
          var d = new Date(iso);
          if (isNaN(d.getTime())) return "";
          return d.toLocaleString("en-GB", { year: "numeric", month: "short", day: "2-digit", hour: "2-digit", minute: "2-digit" });
        } catch (e) {
          return "";
        }
      }

      function setStatus(msg, isError) {
        if (!msg) {
          statusEl.textContent = "";
          return;
        }
        statusEl.innerHTML = isError ? "<strong>Note:</strong> " + escapeHtml(msg) : escapeHtml(msg);
      }

      function setLastSentNoteFromStorage() {
        var iso = localStorage.getItem(STORAGE_KEYS.lastSentAt);
        if (!iso) {
          lastSentNote.textContent = "";
          return;
        }
        var nice = formatLocalTime(iso);
        lastSentNote.textContent = nice ? ("Last sent (queued): " + nice + " (stored on this device only)") : "";
      }

      function getAnonId() {
        var existing = localStorage.getItem(STORAGE_KEYS.anonId);
        if (existing) return existing;

        var id = "anon_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
        localStorage.setItem(STORAGE_KEYS.anonId, id);
        return id;
      }

      function readSnapshot(which) {
        var key = which === "start" ? STORAGE_KEYS.start : STORAGE_KEYS.end;
        var raw = localStorage.getItem(key);
        if (!raw) return null;

        var parsed = safeParse(raw);
        if (!parsed || typeof parsed !== "object") return null;
        return parsed;
      }

      function writeSnapshot(which, data) {
        var key = which === "start" ? STORAGE_KEYS.start : STORAGE_KEYS.end;
        localStorage.setItem(key, JSON.stringify(data));
      }

      function clearAllSnapshots() {
        localStorage.removeItem(STORAGE_KEYS.start);
        localStorage.removeItem(STORAGE_KEYS.end);
      }

      function computeTotal(scores) {
        var total = 0;
        for (var i = 0; i < ITEMS.length; i++) {
          var item = ITEMS[i];
          var v = scores[item.id];
          if (v === 0 || v) total += Number(v);
        }
        return total;
      }

      function scoreToText(total) {
        var pct = MAX_TOTAL === 0 ? 0 : Math.round((total / MAX_TOTAL) * 100);
        return total + "/" + MAX_TOTAL + " (" + pct + "%)";
      }

      function categoriseForGuidance(itemId) {
        if (itemId.indexOf("listen") === 0) return "Listening";
        if (itemId.indexOf("speak") === 0) return "Speaking";
        if (itemId.indexOf("reading") === 0) return "Reading";
        if (itemId.indexOf("writing") === 0) return "Writing";
        if (itemId.indexOf("public") === 0) return "Using Welsh in public";
        return "Welsh confidence";
      }

      function categoryTagText(itemId) {
        if (itemId.indexOf("listen") === 0) return "Listening";
        if (itemId.indexOf("speak") === 0) return "Speaking";
        if (itemId.indexOf("reading") === 0) return "Reading";
        if (itemId.indexOf("writing") === 0) return "Writing";
        if (itemId.indexOf("public") === 0) return "Real-life use";
        return "Confidence";
      }

      function buildForm() {
        var html = "";

        for (var i = 0; i < ITEMS.length; i++) {
          var item = ITEMS[i];
          var legendId = "dt-legend-" + item.id;
          var whyId = "dt-why-" + item.id;
          var notesId = "dt-notes-" + item.id;

          html += "<fieldset class='dt-item' aria-labelledby='" + legendId + "' aria-describedby='" + whyId + "'>";
          html += "  <legend class='dt-legend' id='" + legendId + "'>" + escapeHtml((i + 1) + ". " + item.title) + "</legend>";
          html += "  <p class='dt-why' id='" + whyId + "'>" + escapeHtml(item.why) + "</p>";
          html += "  <div class='dt-tag' aria-label='Skill area'>" + escapeHtml(categoryTagText(item.id)) + "</div>";

          html += "  <div class='dt-scale' role='group' aria-label='Confidence scale'>";
          html += "    <div class='dt-scale-row'>";

          for (var s = 0; s < SCALE.length; s++) {
            var opt = SCALE[s];
            var inputId = "dt-" + item.id + "-" + opt.v;
            var name = "score_" + item.id;

            html += "      <label class='dt-choice' for='" + inputId + "'>";
            html += "        <input type='radio' id='" + inputId + "' name='" + name + "' value='" + opt.v + "' aria-label='" + escapeHtml(opt.a) + " (" + opt.v + ")' />";
            html += "        <span class='dt-num'>" + opt.v + "</span>";
            html += "        <span class='dt-anchor'>" + escapeHtml(opt.a) + "</span>";
            html += "      </label>";
          }

          html += "    </div>";
          html += "  </div>";

          html += "  <div class='dt-notes'>";
          html += "    <label for='" + notesId + "'>Notes to self (private, optional)</label>";
          html += "    <textarea class='dt-textarea' id='" + notesId + "' name='note_" + item.id + "' placeholder='Do not include personal data. For example: where I noticed Welsh, what felt easier, what I want to try next.'></textarea>";
          html += "  </div>";
          html += "</fieldset>";
        }

        form.innerHTML = html;
      }

      function getCurrentResponses() {
        var scores = {};
        var notes = {};

        for (var i = 0; i < ITEMS.length; i++) {
          var item = ITEMS[i];
          var scoreName = "score_" + item.id;
          var selected = form.querySelector("input[name='" + scoreName + "']:checked");

          if (selected) {
            scores[item.id] = Number(selected.value);
          }

          var noteEl = form.querySelector("textarea[name='note_" + item.id + "']");
          notes[item.id] = noteEl ? String(noteEl.value || "") : "";
        }

        return { scores: scores, notes: notes };
      }

      function setResponsesFromSnapshot(snapshot) {
        if (!snapshot) return;

        for (var i = 0; i < ITEMS.length; i++) {
          var item = ITEMS[i];

          var val = snapshot.scores ? snapshot.scores[item.id] : undefined;
          var radios = form.querySelectorAll("input[name='score_" + item.id + "']");
          radios.forEach(function (r) { r.checked = false; });

          if (val === 0 || val) {
            var input = form.querySelector("input[name='score_" + item.id + "'][value='" + val + "']");
            if (input) input.checked = true;
          }

          var noteEl = form.querySelector("textarea[name='note_" + item.id + "']");
          if (noteEl) {
            var n = snapshot.notes && typeof snapshot.notes[item.id] === "string" ? snapshot.notes[item.id] : "";
            noteEl.value = n;
          }
        }
      }

      function updateProgressUI() {
        var current = getCurrentResponses();
        var answeredCount = Object.keys(current.scores).length;
        var total = computeTotal(current.scores);
        var pct = MAX_TOTAL === 0 ? 0 : Math.round((total / MAX_TOTAL) * 100);

        scoreText.innerHTML = "Overall: <strong>" + total + "</strong> out of <strong>" + MAX_TOTAL + "</strong>";
        scorePct.textContent = pct + "%";
        barFill.style.width = pct + "%";

        if (answeredCount === 0) {
          supportMsg.textContent = "Start anywhere. One item is enough for today.";
        } else if (answeredCount < ITEMS.length) {
          supportMsg.textContent = "Nice. You have started. You can leave any item blank if it does not fit today.";
        } else {
          if (pct <= 25) supportMsg.textContent = "This looks like an honest baseline. Being at the start is expected and welcome here.";
          else if (pct <= 55) supportMsg.textContent = "You are building foundations. Keep noticing small wins. They add up.";
          else if (pct <= 80) supportMsg.textContent = "You have lots to work with already. The course can help make it feel more automatic.";
          else supportMsg.textContent = "You are feeling very ready. You can use the course to stay relaxed and make it social.";
        }

        renderSummaryCard();
      }

      function buildGuidanceFromSnapshot(snap) {
        var strengths = [];
        var nextSteps = [];

        for (var i = 0; i < ITEMS.length; i++) {
          var item = ITEMS[i];
          var v = Number((snap.scores || {})[item.id]);
          if (!Number.isFinite(v)) continue;

          if (v >= 3) strengths.push(item);
          else nextSteps.push(item);
        }

        return {
          strengths: strengths.slice(0, 5),
          nextSteps: nextSteps.slice(0, 5)
        };
      }

      function renderSummaryCard() {
        var startSnap = readSnapshot("start");
        var endSnap = readSnapshot("end");

        var current = getCurrentResponses();
        var currentTotal = computeTotal(current.scores);

        var startTotal = startSnap ? computeTotal(startSnap.scores || {}) : null;
        var endTotal = endSnap ? computeTotal(endSnap.scores || {}) : null;

        if (startTotal === null) {
          summaryStartValue.textContent = (mode === "start" && Object.keys(current.scores).length > 0)
            ? scoreToText(currentTotal) + " (not saved)"
            : "Not saved yet";
          summaryStartSub.textContent = "This is your baseline. It is not a test. Saving it helps you see change later.";
        } else {
          summaryStartValue.textContent = scoreToText(startTotal);
          summaryStartSub.textContent = "Baseline captured. You can update it if you want a fresh starting point.";
        }

        if (endTotal === null) {
          summaryEndValue.textContent = (mode === "end" && Object.keys(current.scores).length > 0)
            ? scoreToText(currentTotal) + " (not saved)"
            : "Not saved yet";
          summaryEndSub.textContent = "When you save the End checkpoint, you will see distance travelled clearly.";
        } else {
          summaryEndValue.textContent = scoreToText(endTotal);
          summaryEndSub.textContent = "End checkpoint captured. This reflects how you feel right now, not perfection.";
        }

        if (startTotal !== null && endTotal !== null) {
          var diff = endTotal - startTotal;
          var diffPct = Math.round((diff / MAX_TOTAL) * 100);

          if (diff > 0) {
            summaryDistanceValue.textContent = "+" + diff + " points (" + diffPct + "% of the scale)";
            summaryDistanceSub.textContent = "That is distance travelled. Even small gains are meaningful.";
          } else if (diff < 0) {
            summaryDistanceValue.textContent = diff + " points (" + diffPct + "% of the scale)";
            summaryDistanceSub.textContent = "This can happen when you notice complexity. Awareness is still progress.";
          } else {
            summaryDistanceValue.textContent = "No change in total score";
            summaryDistanceSub.textContent = "Steady confidence is valid. You may also have a more realistic view now.";
          }
        } else {
          summaryDistanceValue.textContent = "Save both checkpoints to compare.";
          summaryDistanceSub.textContent = "You can still print a copy at any time.";
        }

        strengthsList.innerHTML = "";
        nextStepsList.innerHTML = "";

        if (mode === "start") {
          guidanceLists.hidden = false;

          guidanceMessage.textContent =
            "This Start checkpoint is here to create psychological safety. It gives you a baseline so you can notice progress later. " +
            "Starting from scratch is absolutely fine. If you are confident in some areas, that is also welcome. Bring that experience into the room, " +
            "share what you can, and lean into the curiosity threads if you want stretch goals.";

          var base = startSnap || { scores: current.scores };
          var g0 = buildGuidanceFromSnapshot(base);

          g0.strengths.forEach(function (it) {
            strengthsList.innerHTML += "<li>" + escapeHtml(categoriseForGuidance(it.id) + ": " + it.title) + "</li>";
          });

          g0.nextSteps.forEach(function (it) {
            nextStepsList.innerHTML += "<li>" + escapeHtml(categoriseForGuidance(it.id) + ": " + it.title) + "</li>";
          });

          if (strengthsList.innerHTML === "") {
            strengthsList.innerHTML = "<li>Completing the checkpoint is a strength. Start small and build gently.</li>";
          }
          if (nextStepsList.innerHTML === "") {
            nextStepsList.innerHTML = "<li>You are confident across the board. Try supporting someone else or encouraging Welsh use in the group.</li>";
          }

          return;
        }

        if (!endSnap) {
          guidanceLists.hidden = true;
          guidanceMessage.textContent =
            "When you save your End checkpoint, this section will highlight your strengths and suggest calm next steps. " +
            "If you are feeling confident, try the curiosity threads for extra stretch. If you are not, that is still valid. Keep it small and practical.";
          return;
        }

        var g = buildGuidanceFromSnapshot(endSnap);
        guidanceLists.hidden = false;

        if (startSnap && endSnap) {
          var sT = computeTotal(startSnap.scores || {});
          var eT = computeTotal(endSnap.scores || {});
          var d = eT - sT;

          if (d > 0) {
            guidanceMessage.textContent =
              "Nice work. Your End checkpoint suggests increased confidence overall. Keep doing what worked, then gently stretch into real settings. " +
              "Curiosity threads are a good option if you want extra practice without pressure.";
          } else if (d < 0) {
            guidanceMessage.textContent =
              "Your confidence looks different at the end. That can happen when you understand the bigger picture. Use this as information, not judgement. " +
              "Stay low pressure and keep practising little and often.";
          } else {
            guidanceMessage.textContent =
              "Your total score stayed steady. That can still mean progress, especially if you are using Welsh more naturally or noticing more. " +
              "Use the strengths list to keep momentum and choose one small stretch target from the next steps.";
          }
        } else {
          guidanceMessage.textContent =
            "This End checkpoint shows where you feel confident now and what you can grow next. Focus on practical use: listening little and often, " +
            "saying small phrases, and trying Welsh in supportive settings.";
        }

        if (g.strengths.length === 0) {
          strengthsList.innerHTML = "<li>Even finishing the course is a strength. Choose one area you feel most willing to try and build from there.</li>";
        } else {
          g.strengths.forEach(function (it) {
            strengthsList.innerHTML += "<li>" + escapeHtml(categoriseForGuidance(it.id) + ": " + it.title) + "</li>";
          });
        }

        if (g.nextSteps.length === 0) {
          nextStepsList.innerHTML = "<li>You are confident across the board. Try mentoring someone else or encouraging Welsh use in your group.</li>";
        } else {
          g.nextSteps.forEach(function (it) {
            nextStepsList.innerHTML += "<li>" + escapeHtml(categoriseForGuidance(it.id) + ": " + it.title) + "</li>";
          });
        }
      }

      function setMode(nextMode) {
        mode = nextMode;

        modeStartBtn.setAttribute("aria-pressed", mode === "start" ? "true" : "false");
        modeEndBtn.setAttribute("aria-pressed", mode === "end" ? "true" : "false");

        var startSnap = readSnapshot("start");
        var endSnap = readSnapshot("end");

        if (mode === "start") {
          modeHint.textContent = startSnap
            ? "You already have a saved Start checkpoint on this device. You can update it and save again if you want."
            : "Use this in Session 1 to capture your baseline. It is fine if you leave items blank.";
          setResponsesFromSnapshot(startSnap || { scores: {}, notes: {} });
        } else {
          if (endSnap && startSnap) {
            modeHint.textContent = "You have both Start and End saved. You can update your End checkpoint and save again if your confidence has changed.";
          } else if (startSnap) {
            modeHint.textContent = "Use this in Session 6. If you save, the summary shows distance travelled from your Start checkpoint.";
          } else {
            modeHint.textContent = "If you did not do the Start checkpoint, that is still okay. You can use this as a one-off snapshot.";
          }
          setResponsesFromSnapshot(endSnap || { scores: {}, notes: {} });
        }

        setStatus("", false);
        updateProgressUI();
      }

      function validateBeforeSave(current) {
        if (Object.keys(current.scores).length === 0) {
          return { ok: false, msg: "Nothing selected yet. Choose at least one item before saving (or use Print to save a blank copy)." };
        }
        return { ok: true, msg: "" };
      }

      function saveSnapshot() {
        var current = getCurrentResponses();
        var check = validateBeforeSave(current);

        if (!check.ok) {
          setStatus(check.msg, true);
          return;
        }

        var total = computeTotal(current.scores);
        var percent = MAX_TOTAL === 0 ? 0 : Math.round((total / MAX_TOTAL) * 100);

        var payload = {
          version: 1,
          checkpoint: mode,
          savedAt: nowISO(),
          total: total,
          percent: percent,
          scores: current.scores,
          notes: current.notes
        };

        writeSnapshot(mode, payload);
        setStatus("Saved. This stays on this device only.", false);
        updateProgressUI();
      }

      function buildSummaryText() {
        var startSnap = readSnapshot("start");
        var endSnap = readSnapshot("end");
        var activeSnap = readSnapshot(mode);

        var header = "Tidy Butt: Y Cam Cyntaf | Distance Travelled (private confidence check-in)";
        var lineMode = mode === "start" ? "Checkpoint: Start of course" : "Checkpoint: End of course";

        var lines = [];
        lines.push(header);
        lines.push(lineMode);

        if (!activeSnap) {
          lines.push("No saved score yet for this checkpoint.");
        } else {
          lines.push("Overall: " + activeSnap.total + "/" + MAX_TOTAL + " (" + activeSnap.percent + "%)");
        }

        if (startSnap && endSnap) {
          var diff = endSnap.total - startSnap.total;
          if (diff > 0) lines.push("Distance travelled: +" + diff + " points.");
          else if (diff < 0) lines.push("Distance travelled: " + diff + " points. Awareness still counts.");
          else lines.push("Distance travelled: 0 points (steady confidence).");
        } else {
          lines.push("Tip: Save Start and End to see distance travelled.");
        }

        lines.push("Reminder: This is private, not graded, and you cannot fail.");
        return lines.join("\n");
      }

      function copySummary() {
        var text = buildSummaryText();

        if (!navigator.clipboard || !navigator.clipboard.writeText) {
          var ta = document.createElement("textarea");
          ta.value = text;
          ta.setAttribute("readonly", "readonly");
          ta.style.position = "fixed";
          ta.style.top = "0";
          ta.style.left = "0";
          ta.style.opacity = "0";
          document.body.appendChild(ta);
          ta.select();

          try {
            document.execCommand("copy");
            setStatus("Summary copied (fallback). Notes are not included.", false);
          } catch (e) {
            setStatus("Could not copy automatically. You can use Print instead.", true);
          }

          document.body.removeChild(ta);
          return;
        }

        navigator.clipboard.writeText(text)
          .then(function () {
            setStatus("Summary copied. You can paste it into WhatsApp. Notes are not included.", false);
          })
          .catch(function () {
            setStatus("Could not copy automatically. You can use Print instead.", true);
          });
      }

      function downloadWordDoc() {
        var startSnap = readSnapshot("start");
        var endSnap = readSnapshot("end");

        var html = "";
        html += "<html><head><meta charset='utf-8'><title>Distance Travelled</title></head><body>";
        html += "<h1>Distance Travelled: private confidence check-in</h1>";
        html += "<p><strong>Reminder:</strong> This is private, not graded, and you cannot fail.</p>";
        html += "<p><strong>Do not include personal data</strong> in notes.</p>";

        function snapSection(label, snap) {
          if (!snap) {
            html += "<h2>" + label + "</h2><p>Not saved.</p>";
            return;
          }
          html += "<h2>" + label + "</h2>";
          html += "<p>Saved at: " + escapeHtml(snap.savedAt || "") + "</p>";
          html += "<p>Overall: " + escapeHtml(String(snap.total)) + "/" + escapeHtml(String(MAX_TOTAL)) + " (" + escapeHtml(String(snap.percent)) + "%)</p>";

          html += "<h3>Scores</h3><ul>";
          for (var i = 0; i < ITEMS.length; i++) {
            var item = ITEMS[i];
            var v = (snap.scores || {})[item.id];
            if (v === 0 || v) {
              html += "<li>" + escapeHtml(item.title) + " : " + escapeHtml(String(v)) + "/4</li>";
            }
          }
          html += "</ul>";

          html += "<h3>Notes (optional)</h3><ul>";
          for (var j = 0; j < ITEMS.length; j++) {
            var item2 = ITEMS[j];
            var n = (snap.notes || {})[item2.id];
            if (n && String(n).trim()) {
              html += "<li><strong>" + escapeHtml(item2.title) + "</strong><br/>" + escapeHtml(String(n)) + "</li>";
            }
          }
          html += "</ul>";
        }

        snapSection("Start of course", startSnap);
        snapSection("End of course", endSnap);

        if (startSnap && endSnap) {
          var diff = endSnap.total - startSnap.total;
          html += "<h2>Distance travelled</h2>";
          html += "<p>Change: " + (diff > 0 ? "+" : "") + escapeHtml(String(diff)) + " points.</p>";
        }

        html += "</body></html>";

        var blob = new Blob(["\ufeff", html], { type: "application/msword" });
        var url = URL.createObjectURL(blob);

        var a = document.createElement("a");
        a.href = url;
        a.download = "tidybutt-distance-travelled.doc";
        document.body.appendChild(a);
        a.click();
        a.remove();

        URL.revokeObjectURL(url);
        setStatus("Downloaded Word document. You can send it if you choose.", false);
      }

      function resetTool() {
        clearAllSnapshots();

        var inputs = form.querySelectorAll("input[type='radio']");
        inputs.forEach(function (i) { i.checked = false; });

        var notes = form.querySelectorAll("textarea");
        notes.forEach(function (t) { t.value = ""; });

        setStatus("Reset complete. Saved Start and End checkpoints were cleared for this tool only.", false);
        updateProgressUI();
        setMode(mode);
      }

      /* =========================
         SEND (Apps Script)
         Uses sendBeacon to reduce CORS headaches and keep it simple.
         "Sent (queued)" means the browser accepted it for sending.
         ========================= */
      function buildSendPayload() {
        var startSnap = readSnapshot("start");
        var endSnap = readSnapshot("end");

        var diffPoints = null;
        var diffPct = null;

        if (startSnap && endSnap) {
          diffPoints = (endSnap.total || 0) - (startSnap.total || 0);
          diffPct = Math.round((diffPoints / MAX_TOTAL) * 100);
        }

        return {
          courseId: "tidybutt_y_cam_cyntaf",
          toolVersion: "1.0",
          anonId: getAnonId(),
          pageUrl: String(location.href || ""),
          userAgent: String(navigator.userAgent || ""),
          maxTotal: MAX_TOTAL,
          start: startSnap || null,
          end: endSnap || null,
          diff: (startSnap && endSnap)
            ? { points: diffPoints, percentOfScale: diffPct }
            : null
        };
      }

      function sendToTidyButt() {
        if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.indexOf("http") !== 0) {
          setStatus("Send is not configured yet. Add your Apps Script /exec URL in the code.", true);
          return;
        }

        var payload = buildSendPayload();

        if (!payload.start && !payload.end) {
          setStatus("Nothing to send yet. Save at least one checkpoint first.", true);
          return;
        }

        var json = JSON.stringify(payload);

// IMPORTANT: send as text/plain to avoid CORS/preflight issues
        var blob = new Blob([json], { type: "text/plain;charset=UTF-8" });

        var ok = navigator.sendBeacon(APPS_SCRIPT_URL, blob);

        if (ok) {
          var sentAt = nowISO();
          localStorage.setItem(STORAGE_KEYS.lastSentAt, sentAt);
          setLastSentNoteFromStorage();

          setStatus("Sent (queued). Thank you. Please do not include personal data in notes.", false);
        } else {
          setStatus("Could not send right now. You can download the Word document and send it later if you choose.", true);
        }
      }

      /* =========================
         Modal open/close (no aria-hidden focus warning)
         We use data-open plus inert on the main content.
         ========================= */
      function openSendModal() {
        lastFocusEl = document.activeElement;
        consentBox.checked = false;

        modalOverlay.setAttribute("data-open", "true");
        if ("inert" in main) main.inert = true;
        main.setAttribute("aria-hidden", "true");

        modalCancel.focus();
      }

      function closeSendModal() {
        modalOverlay.setAttribute("data-open", "false");
        if ("inert" in main) main.inert = false;
        main.removeAttribute("aria-hidden");

        if (lastFocusEl && typeof lastFocusEl.focus === "function") {
          lastFocusEl.focus();
        }
      }

      function trapFocusInModal(e) {
        if (modalOverlay.getAttribute("data-open") !== "true") return;
        if (e.key !== "Tab") return;

        var focusables = modalOverlay.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        if (!focusables.length) return;

        var first = focusables[0];
        var last = focusables[focusables.length - 1];

        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }

      /* =========================
         Events
         ========================= */
      function attachListeners() {
        modeStartBtn.addEventListener("click", function () { setMode("start"); });
        modeEndBtn.addEventListener("click", function () { setMode("end"); });

        form.addEventListener("change", updateProgressUI);
        form.addEventListener("input", function (e) {
          if (e && e.target && e.target.tagName === "TEXTAREA") updateProgressUI();
        });

        saveBtn.addEventListener("click", saveSnapshot);
        saveBottomBtn.addEventListener("click", saveSnapshot);

        topBtn.addEventListener("click", function () {
          var topTarget = document.getElementById("distance-travelled");
          if (topTarget) topTarget.scrollIntoView({ behavior: "smooth", block: "start" });
        });

        copyBtn.addEventListener("click", copySummary);
        docBtn.addEventListener("click", downloadWordDoc);
        printBtn.addEventListener("click", function () { window.print(); });

        sendBtn.addEventListener("click", openSendModal);

        modalCancel.addEventListener("click", function () {
          closeSendModal();
          setStatus("Send cancelled. Nothing was shared.", false);
        });

        modalSend.addEventListener("click", function () {
          if (!consentBox.checked) {
            setStatus("Please tick the box to confirm you will not include personal data in notes.", true);
            return;
          }
          closeSendModal();
          sendToTidyButt();
        });

        modalOverlay.addEventListener("click", function (e) {
          if (e.target === modalOverlay) closeSendModal();
        });

        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && modalOverlay.getAttribute("data-open") === "true") {
            closeSendModal();
          }
          trapFocusInModal(e);
        });

        resetBtn.addEventListener("click", function () {
          var now = Date.now();
          var last = Number(resetBtn.getAttribute("data-last-click") || 0);

          if (!last || (now - last) > 6000) {
            resetBtn.setAttribute("data-last-click", String(now));
            setStatus("Press Reset again to confirm. This will clear saved Start and End on this device only.", true);
            return;
          }

          resetBtn.removeAttribute("data-last-click");
          resetTool();
        });
      }

      function initFromStorage() {
        setMode("start");
        updateProgressUI();
        setLastSentNoteFromStorage();
      }

      /* =========================
         Boot
         ========================= */
      buildForm();
      attachListeners();
      initFromStorage();
    })();
  </script>
</body>
</html>
